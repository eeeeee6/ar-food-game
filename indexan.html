<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…­å¤§é¡é£Ÿç‰©éŠæˆ²</title>
    
    <!-- ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„ç‰ˆæœ¬ -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(240, 240, 240, 0);
            z-index: 1;
            pointer-events: none;
        }

        #arjs-video {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: 0;
        }

        /* ä¿®æ­£ Android ç›¸æ©Ÿæ”¾å¤§å•é¡Œ */
        video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        .a-canvas {
            z-index: 2 !important;
        }

        #ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #food-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        #food-title {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }

        #food-category {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #confirm-button {
            padding: 12px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        #confirm-button:active {
            background-color: #388E3C;
        }

        #score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #FFD700;
            color: #333;
            padding: 10px 20px;
            border-radius: 25px;
            z-index: 4;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #question-title {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 4;
            font-size: 16px;
            font-weight: bold;
        }

        #question-title .progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin-top: 8px;
        }

        #question-title .progress-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* ä»»å‹™å¡ç‰‡ */
        #mission-card {
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 15px;
            z-index: 4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #mission-card .icon {
            font-size: 35px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 12px;
        }

        #mission-card .text {
            display: flex;
            flex-direction: column;
        }

        #mission-card .label {
            font-size: 12px;
            color: #666;
        }

        #mission-card .target {
            font-size: 18px;
            font-weight: bold;
            color: #E91E63;
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 5;
            font-size: 20px;
            display: none;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loading-text {
            color: white;
            font-size: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #start-screen h1 {
            color: white;
            font-size: 26px;
            margin-bottom: 15px;
            text-align: center;
        }

        #start-screen .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 25px;
        }

        #start-screen .instructions {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            color: white;
            max-width: 300px;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        #start-button {
            padding: 15px 50px;
            font-size: 20px;
            background: white;
            color: #764ba2;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        #marker-link {
            margin-top: 15px;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        #result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #result-screen h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
        }

        #result-screen .score-box {
            background: rgba(255,255,255,0.2);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        #result-screen .final-score {
            color: #FFD700;
            font-size: 60px;
            font-weight: bold;
        }

        #result-screen .score-label {
            color: white;
            font-size: 20px;
        }

        #restart-button {
            padding: 15px 40px;
            font-size: 18px;
            background: white;
            color: #11998e;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Debug info - éš±è— */
        #debug-info {
            display: none !important;
        }

        /* åµæ¸¬ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        #detection-status {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 3;
            display: none;
        }

        #detection-status.detecting {
            display: block;
            background: #FF9800;
        }

        #detection-status.confirmed {
            display: block;
            background: #4CAF50;
        }
    </style>
</head>
<body>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start-screen">
    <h1>ğŸ½ï¸ AR å…­å¤§é¡é£Ÿç‰©éŠæˆ²</h1>
    <p class="subtitle">å¤§ä»ç§‘æŠ€å¤§å­¸ ç¤¾æœƒå·¥ä½œç³»</p>
    <div class="instructions">
        <strong>ğŸ“‹ éŠæˆ²èªªæ˜</strong><br>
        1. ç•«é¢æœƒé¡¯ç¤ºç¼ºå°‘æŸé¡é£Ÿç‰©çš„é¤ç›¤<br>
        2. æ‰¾åˆ°å°æ‡‰çš„é£Ÿç‰©åœ–å¡ä¸¦æƒæ<br>
        3. ç©©å®šå°æº–åœ–å¡ï¼Œå‡ºç¾ç¢ºèªæŒ‰éˆ•<br>
        4. é»æ“Šç¢ºèªæŒ‰éˆ•å¾—åˆ†ï¼Œå…± 6 é¡Œï¼
    </div>
    <button id="start-button">ğŸ® é–‹å§‹éŠæˆ²</button>
    <a id="marker-link" href="marker-generator.html">ğŸ“„ æŸ¥çœ‹/åˆ—å°åœ–å¡</a>
</div>

<!-- è¼‰å…¥ç•«é¢ -->
<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div id="loading-text">æ¨¡å‹è¼‰å…¥ä¸­...</div>
</div>

<!-- çµæœç•«é¢ -->
<div id="result-screen">
    <h1>ğŸ‰ éŠæˆ²çµæŸï¼</h1>
    <div class="score-box">
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">åˆ†</div>
    </div>
    <button id="restart-button">ğŸ”„ å†ç©ä¸€æ¬¡</button>
</div>

<!-- éŠæˆ²ç•«é¢ -->
<div id="background"></div>
<div id="score-display">â­ 0 åˆ†</div>
<div id="question-title">
    ç¬¬ <span id="q-num">1</span> é¡Œ
    <div class="progress"><div class="progress-fill" id="progress-fill"></div></div>
</div>

<!-- ä»»å‹™å¡ç‰‡ -->
<div id="mission-card">
    <div class="icon" id="mission-icon">ğŸ¥¬</div>
    <div class="text">
        <span class="label">ğŸ” è«‹æ‰¾å‡ºç¼ºå°‘çš„é£Ÿç‰©</span>
        <span class="target" id="mission-target">è”¬èœé¡</span>
    </div>
</div>

<div id="notification">è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼</div>
<div id="debug-info">ç­‰å¾…é–‹å§‹...</div>

<!-- åµæ¸¬ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div id="detection-status">åµæ¸¬ä¸­...</div>

<!-- AR å ´æ™¯ - ä¿®æ­£ Android ç›¸æ©Ÿæ”¾å¤§å•é¡Œ -->
<a-scene embedded arjs="
    sourceType: webcam; 
    debugUIEnabled: false; 
    detectionMode: mono_and_matrix; 
    matrixCodeType: 3x3;
    videoTexture: false;
    sourceWidth: 1280;
    sourceHeight: 960;
    displayWidth: 1280;
    displayHeight: 960;
">
    <a-assets>
        <a-asset-item id="food1-model" src="models/food_answer1.glb"></a-asset-item>
        <a-asset-item id="food2-model" src="models/food_answer2.glb"></a-asset-item>
        <a-asset-item id="food3-model" src="models/food_answer3.glb"></a-asset-item>
        <a-asset-item id="food4-model" src="models/food_answer4.glb"></a-asset-item>
        <a-asset-item id="food5-model" src="models/food_answer5.glb"></a-asset-item>
        <a-asset-item id="food6-model" src="models/food_answer6.glb"></a-asset-item>
    </a-assets>

    <!-- Marker è¨­å®š - å¢åŠ  smooth å’Œ smoothCount é™ä½èª¤åˆ¤ -->
    <a-marker id="marker1" type="pattern" url="markers/marker_food1.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food1-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker2" type="pattern" url="markers/marker_food2.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food2-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker3" type="pattern" url="markers/marker_food3.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food3-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker4" type="pattern" url="markers/marker_food4.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food4-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker5" type="pattern" url="markers/marker_food5.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food5-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker6" type="pattern" url="markers/marker_food6.patt" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#food6-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
</a-scene>

<!-- UI è¦†è“‹å±¤ -->
<div id="ui-overlay">
    <div id="food-icon">ğŸ¥¬</div>
    <div id="food-title">é«˜éº—èœ</div>
    <div id="food-category">è”¬èœé¡</div>
    <button id="confirm-button">âœ” ç¢ºèªé¸æ“‡é€™å€‹é£Ÿç‰©</button>
</div>

<script>
// é¡Œç›®è³‡æ–™
const backgrounds = [
    {
        image: 'imgs/food_question1_0.png',
        marker: 'marker1',
        title: 'é«˜éº—èœ',
        category: 'è”¬èœé¡',
        emoji: 'ğŸ¥¬',
        color: '#4CAF50'
    },
    {
        image: 'imgs/food_question2_0.png',
        marker: 'marker2',
        title: 'èŠ±ç”Ÿ',
        category: 'å …æœé¡',
        emoji: 'ğŸ¥œ',
        color: '#FDD835'
    },
    {
        image: 'imgs/food_question3_0.png',
        marker: 'marker3',
        title: 'ç‰›æ’',
        category: 'è±†é­šè›‹è‚‰é¡',
        emoji: 'ğŸ¥©',
        color: '#FF6B6B'
    },
    {
        image: 'imgs/food_question4_0.png',
        marker: 'marker4',
        title: 'æŸ³ä¸',
        category: 'æ°´æœé¡',
        emoji: 'ğŸŠ',
        color: '#E040FB'
    },
    {
        image: 'imgs/food_question5_0.png',
        marker: 'marker5',
        title: 'ç™½é£¯',
        category: 'å…¨ç©€é›œç³§é¡',
        emoji: 'ğŸš',
        color: '#FFB74D'
    },
    {
        image: 'imgs/food_question6_0.png',
        marker: 'marker6',
        title: 'ç‰›å¥¶',
        category: 'ä¹³å“é¡',
        emoji: 'ğŸ¥›',
        color: '#29B6F6'
    }
];

// éŠæˆ²ç‹€æ…‹
let selectedBackgrounds = [];
let currentBackgroundIndex = 0;
let score = 0;
let questionsAnswered = 0;
let currentMarker = null;
let scannedMarker = null;
let loadedModels = 0;
const totalModels = 6;

// â˜…â˜…â˜… æ–°å¢ï¼šé˜²æ­¢èª¤åˆ¤çš„è®Šæ•¸ â˜…â˜…â˜…
let pendingMarker = null;           // æš«æ™‚åµæ¸¬åˆ°çš„ marker
let markerDetectTime = 0;           // é–‹å§‹åµæ¸¬çš„æ™‚é–“
const CONFIRM_DELAY = 500;          // å¿…é ˆæŒçºŒåµæ¸¬ 0.5 ç§’æ‰ç¢ºèª
let markerLostTime = 0;             // marker æ¶ˆå¤±çš„æ™‚é–“
const LOST_TIMEOUT = 2000;          // marker æ¶ˆå¤± 2 ç§’å¾Œæ‰æ¸…é™¤é¸æ“‡
let isMarkerVisible = false;        // marker æ˜¯å¦å¯è¦‹

// DOM å…ƒç´ 
const background = document.getElementById('background');
const uiOverlay = document.getElementById('ui-overlay');
const scoreDisplay = document.getElementById('score-display');
const confirmButton = document.getElementById('confirm-button');
const questionTitle = document.getElementById('question-title');
const notification = document.getElementById('notification');
const debugInfo = document.getElementById('debug-info');
const startScreen = document.getElementById('start-screen');
const startButton = document.getElementById('start-button');
const loadingOverlay = document.getElementById('loading-overlay');
const resultScreen = document.getElementById('result-screen');
const restartButton = document.getElementById('restart-button');
const detectionStatus = document.getElementById('detection-status');
const missionCard = document.getElementById('mission-card');

// é™¤éŒ¯æ—¥èªŒ
function log(msg) {
    console.log('[AR]', msg);
    debugInfo.innerHTML = msg + '<br>' + debugInfo.innerHTML.split('<br>').slice(0, 5).join('<br>');
}

// æ´—ç‰Œå‡½æ•¸
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// é¸æ“‡éš¨æ©Ÿé¡Œç›®
function selectRandomBackgrounds() {
    selectedBackgrounds = shuffleArray(backgrounds);
}

// è¨­å®šèƒŒæ™¯
function setBackground() {
    const current = selectedBackgrounds[currentBackgroundIndex];
    background.style.backgroundImage = `url(${current.image})`;
    currentMarker = current.marker;
    
    // æ›´æ–°ä»»å‹™å¡ç‰‡
    document.getElementById('mission-icon').textContent = current.emoji;
    document.getElementById('mission-target').textContent = current.category;
    document.getElementById('mission-target').style.color = current.color;
    
    log('é¡Œç›®: ' + current.category);
}

// æ›´æ–°åˆ†æ•¸é¡¯ç¤º
function updateScoreDisplay() {
    scoreDisplay.textContent = `â­ ${score} åˆ†`;
}

// æ›´æ–°é¡Œç›®æ¨™é¡Œ
function updateQuestionTitle() {
    document.getElementById('q-num').textContent = questionsAnswered + 1;
    document.getElementById('progress-fill').style.width = ((questionsAnswered) / 6 * 100) + '%';
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(msg) {
    notification.textContent = msg || 'è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼';
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 2000);
}

// ä¸‹ä¸€é¡Œ
function nextQuestion() {
    questionsAnswered++;
    if (questionsAnswered < 6) {
        currentBackgroundIndex++;
        setBackground();
        updateQuestionTitle();
        uiOverlay.style.display = 'none';
        
        // â˜…â˜…â˜… é‡ç½®åµæ¸¬ç‹€æ…‹ â˜…â˜…â˜…
        scannedMarker = null;
        pendingMarker = null;
        isMarkerVisible = false;
        detectionStatus.className = '';
        detectionStatus.style.display = 'none';
        
        showNotification();
    } else {
        endGame();
    }
}

// çµæŸéŠæˆ²
function endGame() {
    log('éŠæˆ²çµæŸ: ' + score + 'åˆ†');
    background.style.backgroundImage = 'none';
    uiOverlay.style.display = 'none';
    missionCard.style.display = 'none';
    document.getElementById('final-score').textContent = score;
    resultScreen.style.display = 'flex';
}

// é–‹å§‹éŠæˆ²
function startGame() {
    log('éŠæˆ²é–‹å§‹');
    startScreen.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
        missionCard.style.display = 'flex';
        selectRandomBackgrounds();
        currentBackgroundIndex = 0;
        score = 0;
        questionsAnswered = 0;
        scannedMarker = null;
        pendingMarker = null;
        isMarkerVisible = false;
        updateScoreDisplay();
        setBackground();
        updateQuestionTitle();
    }, 2000);
}

// é‡æ–°é–‹å§‹
function restartGame() {
    resultScreen.style.display = 'none';
    missionCard.style.display = 'flex';
    selectRandomBackgrounds();
    currentBackgroundIndex = 0;
    score = 0;
    questionsAnswered = 0;
    scannedMarker = null;
    pendingMarker = null;
    isMarkerVisible = false;
    updateScoreDisplay();
    setBackground();
    updateQuestionTitle();
}

// â˜…â˜…â˜… æ›´æ–° UI é¡¯ç¤ºå·²é¸æ“‡çš„é£Ÿç‰© â˜…â˜…â˜…
function showSelectedFood(markerId) {
    const foodItem = backgrounds.find(bg => bg.marker === markerId);
    if (foodItem) {
        document.getElementById('food-icon').textContent = foodItem.emoji;
        document.getElementById('food-title').textContent = foodItem.title;
        document.getElementById('food-category').textContent = foodItem.category;
        document.getElementById('food-title').style.color = foodItem.color;
        uiOverlay.style.display = 'block';
    }
}

// ç¢ºèªæŒ‰éˆ•äº‹ä»¶
confirmButton.addEventListener('click', () => {
    if (!scannedMarker) {
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'warning',
            title: 'è«‹å…ˆæƒæé£Ÿç‰©åœ–å¡ï¼',
            showConfirmButton: false,
            timer: 1200
        });
        return;
    }
    
    log('ç¢ºèª: ' + scannedMarker + ' vs ' + currentMarker);
    if (scannedMarker === currentMarker) {
        score++;
        updateScoreDisplay();
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'success',
            title: 'ç­”å°äº†ï¼+1 åˆ† ğŸ‰',
            showConfirmButton: false,
            timer: 1200,
            background: 'rgba(76,175,80,0.95)',
            color: 'white'
        });
    } else {
        const correct = selectedBackgrounds[currentBackgroundIndex];
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'error',
            title: `ç­”éŒ¯äº†ï¼æ­£ç¢ºæ˜¯ ${correct.emoji} ${correct.category}`,
            showConfirmButton: false,
            timer: 1500,
            background: 'rgba(244,67,54,0.95)',
            color: 'white'
        });
    }
    setTimeout(nextQuestion, 1500);
});

// é–‹å§‹æŒ‰éˆ•äº‹ä»¶
startButton.addEventListener('click', startGame);

// é‡æ–°é–‹å§‹æŒ‰éˆ•äº‹ä»¶
restartButton.addEventListener('click', restartGame);

// â˜…â˜…â˜… æ”¹é€²çš„ Marker åµæ¸¬ç³»çµ± â˜…â˜…â˜…
const markerSystem = {
    currentModel: null,
    initialScale: {x: 0.1, y: 0.1, z: 0.1},
    initialRotation: {x: -90, y: 0, z: 0},
    lastPosition: {x: 0, y: 0},
    initialDistance: 0,
    isMoving: false,
    isScaling: false,

    init() {
        document.querySelectorAll('a-marker').forEach(marker => {
            marker.addEventListener('markerFound', this.onMarkerFound.bind(this));
            marker.addEventListener('markerLost', this.onMarkerLost.bind(this));
        });

        document.addEventListener('touchstart', this.onTouchStart.bind(this));
        document.addEventListener('touchmove', this.onTouchMove.bind(this));
        document.addEventListener('touchend', this.onTouchEnd.bind(this));
        
        // å®šæ™‚æª¢æŸ¥ marker ç‹€æ…‹
        setInterval(this.checkMarkerState.bind(this), 100);
        
        log('Marker ç›£è½å·²è¨­å®šï¼ˆå·²åŠ å¼·é˜²èª¤åˆ¤ï¼‰');
    },

    // â˜…â˜…â˜… æ”¹é€²çš„ markerFound â˜…â˜…â˜…
    onMarkerFound(event) {
        const markerId = event.target.id;
        const now = Date.now();
        
        log('åµæ¸¬åˆ°: ' + markerId);
        
        // å¦‚æœæ˜¯æ–°çš„ markerï¼Œé–‹å§‹è¨ˆæ™‚
        if (pendingMarker !== markerId) {
            pendingMarker = markerId;
            markerDetectTime = now;
            detectionStatus.textContent = 'åµæ¸¬ä¸­...';
            detectionStatus.className = 'detecting';
        }
        
        isMarkerVisible = true;
        markerLostTime = 0;
        
        // è¨­å®šç•¶å‰æ¨¡å‹
        this.currentModel = event.target.querySelector('a-entity');
        if (this.currentModel) {
            this.initialScale = this.currentModel.getAttribute('scale');
            this.initialRotation = this.currentModel.getAttribute('rotation');
        }
    },

    // â˜…â˜…â˜… æ”¹é€²çš„ markerLost â˜…â˜…â˜…
    onMarkerLost(event) {
        const markerId = event.target.id;
        log('æ¶ˆå¤±: ' + markerId);
        
        isMarkerVisible = false;
        markerLostTime = Date.now();
        
        // å¦‚æœæ­£åœ¨åµæ¸¬é€™å€‹ markerï¼Œå–æ¶ˆåµæ¸¬
        if (pendingMarker === markerId && !scannedMarker) {
            pendingMarker = null;
            detectionStatus.className = '';
            detectionStatus.style.display = 'none';
        }
        
        this.currentModel = null;
    },

    // â˜…â˜…â˜… å®šæ™‚æª¢æŸ¥ marker ç‹€æ…‹ â˜…â˜…â˜…
    checkMarkerState() {
        const now = Date.now();
        
        // æª¢æŸ¥æ˜¯å¦æŒçºŒåµæ¸¬åˆ°è¶³å¤ æ™‚é–“
        if (pendingMarker && isMarkerVisible && !scannedMarker) {
            if (now - markerDetectTime >= CONFIRM_DELAY) {
                // ç¢ºèªåµæ¸¬æˆåŠŸ
                scannedMarker = pendingMarker;
                log('âœ“ ç¢ºèªåµæ¸¬: ' + scannedMarker);
                detectionStatus.textContent = 'å·²åµæ¸¬ âœ“';
                detectionStatus.className = 'confirmed';
                showSelectedFood(scannedMarker);
            }
        }
        
        // æª¢æŸ¥ marker æ¶ˆå¤±æ˜¯å¦è¶…éæ™‚é–“
        if (scannedMarker && !isMarkerVisible && markerLostTime > 0) {
            if (now - markerLostTime >= LOST_TIMEOUT) {
                // æ¸…é™¤é¸æ“‡
                log('âš  è¶…æ™‚æ¸…é™¤é¸æ“‡');
                scannedMarker = null;
                pendingMarker = null;
                uiOverlay.style.display = 'none';
                detectionStatus.className = '';
                detectionStatus.style.display = 'none';
            }
        }
    },

    onTouchStart(event) {
        if (!this.currentModel) return;

        if (event.touches.length === 2) {
            this.isScaling = true;
            this.initialDistance = this.getDistance(event.touches[0], event.touches[1]);
        } else if (event.touches.length === 1) {
            this.isMoving = true;
            this.lastPosition = {
                x: event.touches[0].pageX,
                y: event.touches[0].pageY
            };
        }
    },

    onTouchMove(event) {
        if (!this.currentModel) return;

        if (this.isScaling && event.touches.length === 2) {
            const currentDistance = this.getDistance(event.touches[0], event.touches[1]);
            const scaleFactor = currentDistance / this.initialDistance;

            const minScale = 0.05;
            const maxScale = 0.3;
            let newScale = {
                x: Math.min(Math.max(this.initialScale.x * scaleFactor, minScale), maxScale),
                y: Math.min(Math.max(this.initialScale.y * scaleFactor, minScale), maxScale),
                z: Math.min(Math.max(this.initialScale.z * scaleFactor, minScale), maxScale)
            };

            this.currentModel.setAttribute('scale', newScale);

        } else if (this.isMoving && event.touches.length === 1) {
            const deltaX = event.touches[0].pageX - this.lastPosition.x;
            const deltaY = event.touches[0].pageY - this.lastPosition.y;

            const currentPosition = this.currentModel.getAttribute('position');
            const sensitivity = 0.002;

            this.currentModel.setAttribute('position', {
                x: currentPosition.x + deltaX * sensitivity,
                y: currentPosition.y - deltaY * sensitivity,
                z: currentPosition.z
            });

            this.lastPosition = {
                x: event.touches[0].pageX,
                y: event.touches[0].pageY
            };
        }
    },

    onTouchEnd() {
        if (this.currentModel) {
            this.isMoving = false;
            this.isScaling = false;
            this.initialScale = this.currentModel.getAttribute('scale');
        }
    },

    getDistance(touch1, touch2) {
        const dx = touch1.pageX - touch2.pageX;
        const dy = touch1.pageY - touch2.pageY;
        return Math.sqrt(dx * dx + dy * dy);
    }
};

// æ¨¡å‹è¼‰å…¥æª¢æŸ¥
function checkAllModelsLoaded() {
    loadedModels++;
    document.getElementById('loading-text').textContent = `æ¨¡å‹è¼‰å…¥ä¸­... (${loadedModels}/${totalModels})`;
    if (loadedModels === totalModels) {
        log('æ‰€æœ‰æ¨¡å‹å·²è¼‰å…¥');
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    log('é é¢è¼‰å…¥å®Œæˆ');
    
    // ç›£è½æ¨¡å‹è¼‰å…¥
    for (let i = 1; i <= totalModels; i++) {
        const model = document.querySelector(`#food${i}-model`);
        if (model) {
            model.addEventListener('loaded', checkAllModelsLoaded);
        }
    }
    
    // åˆå§‹åŒ– marker ç³»çµ±
    const scene = document.querySelector('a-scene');
    if (scene.hasLoaded) {
        markerSystem.init();
    } else {
        scene.addEventListener('loaded', () => {
            log('AR å ´æ™¯å°±ç·’');
            markerSystem.init();
        });
    }
});
</script>
</body>
</html>
