<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <title>AR å…­å¤§é¡é£Ÿç‰©éŠæˆ²</title>
    
    <!-- A-Frame å’Œ AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif; touch-action: manipulation; }
        .a-canvas { z-index: 1 !important; }

        #question-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: contain; background-position: center; background-repeat: no-repeat;
            z-index: 2; pointer-events: none; opacity: 0.85; display: none;
        }

        #score-display {
            position: fixed; top: env(safe-area-inset-top, 10px); right: 10px; margin-top: 10px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.95));
            color: #FFD700; padding: 10px 16px; border-radius: 12px; z-index: 100;
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #question-title {
            position: fixed; top: env(safe-area-inset-top, 10px); left: 10px; margin-top: 10px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.95));
            color: white; padding: 10px 16px; border-radius: 12px; z-index: 100;
            font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #question-title .target { display: block; font-size: 14px; margin-top: 5px; }

        #tracking-status {
            position: fixed; top: env(safe-area-inset-top, 10px); left: 50%; transform: translateX(-50%);
            margin-top: 70px; background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px;
            z-index: 100; display: flex; align-items: center; gap: 8px;
        }
        #tracking-status .dot { width: 10px; height: 10px; border-radius: 50%; background: #666; transition: all 0.3s; }
        #tracking-status .dot.active { background: #4CAF50; box-shadow: 0 0 12px #4CAF50; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        #tracking-status .text { color: white; font-size: 13px; }

        #detection-progress {
            position: fixed; bottom: 190px; left: 50%; transform: translateX(-50%);
            width: 70%; max-width: 280px; height: 12px; background: rgba(255,255,255,0.3);
            border-radius: 6px; overflow: hidden; z-index: 100; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }
        #detection-progress .bar { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A, #CDDC39); width: 0%; transition: width 0.05s linear; border-radius: 6px; }

        #ui-overlay {
            position: fixed; bottom: env(safe-area-inset-bottom, 15px); left: 50%; transform: translateX(-50%);
            margin-bottom: 15px; z-index: 100; text-align: center;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,20,0.98));
            padding: 18px 28px; border-radius: 20px; display: none;
            box-shadow: 0 8px 35px rgba(0,0,0,0.6); min-width: 260px; max-width: 90%;
        }
        #food-title { color: white; font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        #food-category { color: #aaa; font-size: 14px; margin-bottom: 12px; }
        #confirm-button {
            padding: 12px 35px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white;
            border: none; border-radius: 30px; cursor: pointer; font-size: 17px; font-weight: bold;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4); width: 100%;
        }
        #confirm-button:active { transform: scale(0.95); }

        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95); color: white; padding: 25px 40px; border-radius: 20px;
            z-index: 200; font-size: 20px; display: none; text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.7);
        }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 500; padding: 25px;
        }
        #start-screen h1 { color: white; font-size: 26px; margin-bottom: 12px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); text-align: center; }
        #start-screen .subtitle { color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 20px; }
        #start-screen .instructions { background: rgba(255,255,255,0.15); padding: 22px; border-radius: 18px; color: white; max-width: 320px; margin-bottom: 25px; line-height: 1.8; }
        #start-screen .instructions h3 { margin-bottom: 12px; font-size: 17px; }
        #start-screen .instructions p { margin: 8px 0; font-size: 14px; display: flex; align-items: flex-start; gap: 10px; }
        #start-screen .instructions .step-num { background: rgba(255,255,255,0.25); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
        #start-button { padding: 16px 60px; font-size: 20px; background: white; color: #764ba2; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 10px 35px rgba(0,0,0,0.3); }
        #start-button:active { transform: scale(0.95); }
        #marker-link { margin-top: 18px; color: rgba(255,255,255,0.9); font-size: 14px; text-decoration: underline; cursor: pointer; }

        #result-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 500; padding: 25px;
        }
        #result-screen h1 { color: white; font-size: 30px; margin-bottom: 20px; }
        #result-screen .score-box { background: rgba(255,255,255,0.2); padding: 35px 55px; border-radius: 25px; text-align: center; margin-bottom: 20px; }
        #result-screen .final-score { color: #FFD700; font-size: 72px; font-weight: bold; line-height: 1; }
        #result-screen .score-label { color: white; font-size: 22px; margin-top: 8px; }
        #result-screen .accuracy { color: rgba(255,255,255,0.9); font-size: 18px; margin-top: 12px; }
        #result-screen .stats { color: rgba(255,255,255,0.8); font-size: 14px; margin-top: 8px; }
        #restart-button { padding: 16px 50px; font-size: 18px; background: white; color: #11998e; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }

        #camera-prompt {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 550; padding: 30px; text-align: center;
        }
        #camera-prompt .icon { font-size: 55px; margin-bottom: 18px; }
        #camera-prompt h2 { color: white; margin-bottom: 12px; font-size: 22px; }
        #camera-prompt p { color: rgba(255,255,255,0.8); margin-bottom: 22px; line-height: 1.6; font-size: 15px; }
        #camera-prompt button { padding: 14px 35px; font-size: 17px; background: white; color: #2c3e50; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }

        #debug-info {
            position: fixed; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.85); color: #0f0; padding: 10px 14px;
            border-radius: 10px; font-size: 11px; z-index: 1000;
            font-family: monospace; max-width: 220px; line-height: 1.5;
        }
    </style>
</head>
<body>

<div id="start-screen">
    <h1>ğŸ½ï¸ AR å…­å¤§é¡é£Ÿç‰©éŠæˆ²</h1>
    <p class="subtitle">å¤§ä»ç§‘æŠ€å¤§å­¸ ç¤¾æœƒå·¥ä½œç³»</p>
    <div class="instructions">
        <h3>ğŸ“‹ éŠæˆ²èªªæ˜</h3>
        <p><span class="step-num">1</span> ç•«é¢æœƒé¡¯ç¤ºç¼ºå°‘æŸé¡é£Ÿç‰©çš„é¤ç›¤</p>
        <p><span class="step-num">2</span> æ‰¾åˆ°å°æ‡‰çš„é£Ÿç‰©åœ–å¡ä¸¦æƒæ</p>
        <p><span class="step-num">3</span> å°æº–åœ–å¡ 2 ç§’è‡ªå‹•å¾—åˆ†</p>
        <p><span class="step-num">4</span> å…± 6 é¡Œï¼Œä¾†æŒ‘æˆ°æ»¿åˆ†å§ï¼</p>
    </div>
    <button id="start-button">ğŸ® é–‹å§‹éŠæˆ²</button>
    <a id="marker-link" href="marker-generator.html">ğŸ“„ æŸ¥çœ‹/åˆ—å°åœ–å¡</a>
</div>

<div id="camera-prompt">
    <div class="icon">ğŸ“¸</div>
    <h2>éœ€è¦ç›¸æ©Ÿæ¬Šé™</h2>
    <p>é€™å€‹éŠæˆ²éœ€è¦ä½¿ç”¨ç›¸æ©Ÿä¾†æƒæé£Ÿç‰©åœ–å¡ã€‚<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸¦å…è¨±ç›¸æ©Ÿå­˜å–ã€‚</p>
    <button onclick="requestCameraPermission()">å…è¨±ä½¿ç”¨ç›¸æ©Ÿ</button>
</div>

<div id="result-screen">
    <h1>ğŸ‰ éŠæˆ²çµæŸï¼</h1>
    <div class="score-box">
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">åˆ†</div>
        <div class="accuracy" id="accuracy">æ­£ç¢ºç‡: 0%</div>
        <div class="stats" id="stats">ç­”å° 0 é¡Œ / å…± 6 é¡Œ</div>
    </div>
    <button id="restart-button">ğŸ”„ å†ç©ä¸€æ¬¡</button>
</div>

<div id="question-background"></div>
<div id="score-display">åˆ†æ•¸: 0</div>
<div id="question-title">ç¬¬ 1 é¡Œ<span class="target">æ‰¾ï¼šè”¬èœé¡</span></div>
<div id="tracking-status"><div class="dot" id="tracking-dot"></div><span class="text" id="tracking-text">ç­‰å¾…æƒæ...</span></div>
<div id="detection-progress"><div class="bar" id="detection-bar"></div></div>
<div id="notification"></div>
<div id="debug-info">è¼‰å…¥ä¸­...</div>

<!-- A-Frame AR å ´æ™¯ -->
<a-scene 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.75;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;">

    <!-- é è¼‰ 3D æ¨¡å‹ -->
    <a-assets timeout="60000">
        <a-asset-item id="model-1" src="models/food_answer1.glb"></a-asset-item>
        <a-asset-item id="model-2" src="models/food_answer2.glb"></a-asset-item>
        <a-asset-item id="model-3" src="models/food_answer3.glb"></a-asset-item>
        <a-asset-item id="model-4" src="models/food_answer4.glb"></a-asset-item>
        <a-asset-item id="model-5" src="models/food_answer5.glb"></a-asset-item>
        <a-asset-item id="model-6" src="models/food_answer6.glb"></a-asset-item>
    </a-assets>

    <!-- Marker 1: è”¬èœé¡ -->
    <a-marker type="pattern" url="markers/marker_food1.patt" id="marker-1" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-1" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="è”¬èœé¡" position="0 0.7 0" align="center" color="#4CAF50" scale="1 1 1" side="double"></a-text>
    </a-marker>
    
    <!-- Marker 2: å …æœé¡ -->
    <a-marker type="pattern" url="markers/marker_food2.patt" id="marker-2" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-2" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="å …æœé¡" position="0 0.7 0" align="center" color="#FDD835" scale="1 1 1" side="double"></a-text>
    </a-marker>
    
    <!-- Marker 3: è±†é­šè›‹è‚‰é¡ -->
    <a-marker type="pattern" url="markers/marker_food3.patt" id="marker-3" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-3" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="è±†é­šè›‹è‚‰é¡" position="0 0.7 0" align="center" color="#FF6B6B" scale="0.8 0.8 0.8" side="double"></a-text>
    </a-marker>
    
    <!-- Marker 4: æ°´æœé¡ -->
    <a-marker type="pattern" url="markers/marker_food4.patt" id="marker-4" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-4" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="æ°´æœé¡" position="0 0.7 0" align="center" color="#E040FB" scale="1 1 1" side="double"></a-text>
    </a-marker>
    
    <!-- Marker 5: å…¨ç©€é›œç³§é¡ -->
    <a-marker type="pattern" url="markers/marker_food5.patt" id="marker-5" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-5" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="å…¨ç©€é›œç³§é¡" position="0 0.7 0" align="center" color="#FFB74D" scale="0.8 0.8 0.8" side="double"></a-text>
    </a-marker>
    
    <!-- Marker 6: ä¹³å“é¡ -->
    <a-marker type="pattern" url="markers/marker_food6.patt" id="marker-6" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
        <a-entity gltf-model="#model-6" scale="0.4 0.4 0.4" position="0 0.1 0"
            animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true"></a-entity>
        <a-text value="ä¹³å“é¡" position="0 0.7 0" align="center" color="#29B6F6" scale="1 1 1" side="double"></a-text>
    </a-marker>

    <a-entity camera></a-entity>
</a-scene>

<div id="ui-overlay">
    <div id="food-title"></div>
    <div id="food-category"></div>
    <button id="confirm-button">âœ“ ç¢ºèªé¸æ“‡</button>
</div>

<script>
const questionData = [
    { image: 'imgs/food_question1_0.png', missingCategory: 'è”¬èœé¡', correctMarkerId: 1, color: '#4CAF50' },
    { image: 'imgs/food_question2_0.png', missingCategory: 'å …æœé¡', correctMarkerId: 2, color: '#FDD835' },
    { image: 'imgs/food_question3_0.png', missingCategory: 'è±†é­šè›‹è‚‰é¡', correctMarkerId: 3, color: '#FF6B6B' },
    { image: 'imgs/food_question4_0.png', missingCategory: 'æ°´æœé¡', correctMarkerId: 4, color: '#E040FB' },
    { image: 'imgs/food_question5_0.png', missingCategory: 'å…¨ç©€é›œç³§é¡', correctMarkerId: 5, color: '#FFB74D' },
    { image: 'imgs/food_question6_0.png', missingCategory: 'ä¹³å“é¡', correctMarkerId: 6, color: '#29B6F6' }
];

const markerData = [
    { id: 1, title: 'èŠ±æ¤°èœ', category: 'è”¬èœé¡', color: '#4CAF50' },
    { id: 2, title: 'å …æœ', category: 'å …æœé¡', color: '#FDD835' },
    { id: 3, title: 'ç‰›æ’', category: 'è±†é­šè›‹è‚‰é¡', color: '#FF6B6B' },
    { id: 4, title: 'æ°´æœ', category: 'æ°´æœé¡', color: '#E040FB' },
    { id: 5, title: 'ç™½é£¯', category: 'å…¨ç©€é›œç³§é¡', color: '#FFB74D' },
    { id: 6, title: 'ç‰›å¥¶', category: 'ä¹³å“é¡', color: '#29B6F6' }
];

let gameState = { 
    isPlaying: false, currentQuestion: 0, totalQuestions: 6, score: 0, 
    questions: [], currentAnswer: null, scannedMarkerId: null, 
    isDetecting: false, detectionStartTime: null, autoConfirmDelay: 2000
};

const el = {
    startScreen: document.getElementById('start-screen'),
    startButton: document.getElementById('start-button'),
    cameraPrompt: document.getElementById('camera-prompt'),
    resultScreen: document.getElementById('result-screen'),
    finalScore: document.getElementById('final-score'),
    accuracy: document.getElementById('accuracy'),
    stats: document.getElementById('stats'),
    restartButton: document.getElementById('restart-button'),
    scoreDisplay: document.getElementById('score-display'),
    questionTitle: document.getElementById('question-title'),
    questionBackground: document.getElementById('question-background'),
    trackingDot: document.getElementById('tracking-dot'),
    trackingText: document.getElementById('tracking-text'),
    detectionProgress: document.getElementById('detection-progress'),
    detectionBar: document.getElementById('detection-bar'),
    uiOverlay: document.getElementById('ui-overlay'),
    foodTitle: document.getElementById('food-title'),
    foodCategory: document.getElementById('food-category'),
    confirmButton: document.getElementById('confirm-button'),
    notification: document.getElementById('notification'),
    debug: document.getElementById('debug-info')
};

function log(msg) {
    console.log('[AR]', msg);
    el.debug.innerHTML = msg + '<br>' + el.debug.innerHTML.split('<br>').slice(0, 6).join('<br>');
}

function shuffle(arr) { 
    const a = [...arr]; 
    for (let i = a.length - 1; i > 0; i--) { 
        const j = Math.floor(Math.random() * (i + 1)); 
        [a[i], a[j]] = [a[j], a[i]]; 
    } 
    return a; 
}

function notify(msg, dur = 2000) { 
    el.notification.textContent = msg; 
    el.notification.style.display = 'block'; 
    setTimeout(() => el.notification.style.display = 'none', dur); 
}

async function requestCameraPermission() {
    try { 
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); 
        s.getTracks().forEach(t => t.stop()); 
        el.cameraPrompt.style.display = 'none'; 
        initGame(); 
    } catch(e) { 
        log('ç›¸æ©ŸéŒ¯èª¤: ' + e.message);
        Swal.fire({ icon: 'error', title: 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ', text: 'è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™' }); 
    }
}

function initGame() {
    log('éŠæˆ²é–‹å§‹');
    gameState.questions = shuffle([...questionData]); 
    gameState.currentQuestion = 0; 
    gameState.score = 0; 
    gameState.isPlaying = true;
    gameState.totalQuestions = gameState.questions.length;
    el.startScreen.style.display = 'none'; 
    el.resultScreen.style.display = 'none';
    updateUI(); 
    showQuestion();
}

function showQuestion() {
    const q = gameState.questions[gameState.currentQuestion]; 
    gameState.currentAnswer = q.correctMarkerId;
    el.questionBackground.style.backgroundImage = `url(${q.image})`; 
    el.questionBackground.style.display = 'block';
    el.questionTitle.innerHTML = `ç¬¬ ${gameState.currentQuestion + 1} é¡Œ<span class="target" style="color:${q.color}">æ‰¾ï¼š${q.missingCategory}</span>`;
    log('é¡Œç›®' + (gameState.currentQuestion + 1) + ': ' + q.missingCategory);
    resetDetection();
}

function updateUI() { el.scoreDisplay.textContent = `åˆ†æ•¸: ${gameState.score}`; }

function resetDetection() {
    gameState.isDetecting = false; 
    gameState.detectionStartTime = null; 
    gameState.scannedMarkerId = null;
    el.detectionProgress.style.display = 'none'; 
    el.detectionBar.style.width = '0%';
    el.uiOverlay.style.display = 'none'; 
    el.trackingDot.classList.remove('active'); 
    el.trackingText.textContent = 'ç­‰å¾…æƒæ...';
}

function startDetection(markerId) {
    if (!gameState.isPlaying) return;
    const id = parseInt(markerId.split('-')[1]);
    log('åµæ¸¬ Marker ' + id);
    
    if (gameState.isDetecting && gameState.scannedMarkerId === id) return;
    
    gameState.scannedMarkerId = id; 
    gameState.isDetecting = true; 
    gameState.detectionStartTime = Date.now();
    
    el.trackingDot.classList.add('active'); 
    el.trackingText.textContent = 'åµæ¸¬ä¸­...'; 
    el.detectionProgress.style.display = 'block';
    
    const m = markerData.find(x => x.id === id);
    if (m) { 
        el.foodTitle.textContent = m.title; 
        el.foodTitle.style.color = m.color; 
        el.foodCategory.textContent = m.category; 
        el.uiOverlay.style.display = 'block'; 
    }
    updateProgress();
}

function updateProgress() {
    if (!gameState.isDetecting) return;
    const progress = Math.min((Date.now() - gameState.detectionStartTime) / gameState.autoConfirmDelay * 100, 100);
    el.detectionBar.style.width = `${progress}%`;
    if (progress >= 100) confirmAnswer(); 
    else requestAnimationFrame(updateProgress);
}

function stopDetection() {
    if (!gameState.isDetecting) return;
    log('è¿½è¹¤ä¸Ÿå¤±');
    gameState.isDetecting = false; 
    el.trackingDot.classList.remove('active'); 
    el.trackingText.textContent = 'è¿½è¹¤ä¸Ÿå¤±';
    setTimeout(() => { 
        if (!gameState.isDetecting) { 
            el.detectionProgress.style.display = 'none'; 
            el.detectionBar.style.width = '0%'; 
            el.uiOverlay.style.display = 'none'; 
        } 
    }, 300);
}

function confirmAnswer() {
    if (gameState.scannedMarkerId === null || !gameState.isPlaying) return;
    gameState.isDetecting = false;
    const isCorrect = gameState.scannedMarkerId === gameState.currentAnswer;
    log(isCorrect ? 'ç­”å°ï¼' : 'ç­”éŒ¯');
    
    if (isCorrect) { 
        gameState.score++; 
        updateUI(); 
        Swal.fire({ toast: true, position: 'center', icon: 'success', title: 'ç­”å°äº†ï¼+1 åˆ† ğŸ‰', showConfirmButton: false, timer: 1200, background: 'rgba(76,175,80,0.95)', color: 'white' }); 
    } else { 
        const cm = markerData.find(x => x.id === gameState.currentAnswer); 
        Swal.fire({ toast: true, position: 'center', icon: 'error', title: `ç­”éŒ¯äº†ï¼æ­£ç¢ºæ˜¯ ${cm?.category || ''}`, showConfirmButton: false, timer: 1500, background: 'rgba(244,67,54,0.95)', color: 'white' }); 
    }
    
    setTimeout(() => { 
        gameState.currentQuestion++; 
        if (gameState.currentQuestion < gameState.totalQuestions) { 
            showQuestion(); 
            notify('è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼'); 
        } else endGame();
    }, 1600);
}

function endGame() {
    log('éŠæˆ²çµæŸ');
    gameState.isPlaying = false; 
    el.questionBackground.style.display = 'none';
    const acc = Math.round(gameState.score / gameState.totalQuestions * 100);
    el.finalScore.textContent = gameState.score; 
    el.accuracy.textContent = `æ­£ç¢ºç‡: ${acc}%`;
    el.stats.textContent = `ç­”å° ${gameState.score} é¡Œ / å…± ${gameState.totalQuestions} é¡Œ`;
    el.resultScreen.style.display = 'flex'; 
    resetDetection();
}

el.startButton.addEventListener('click', async () => { 
    log('é»æ“Šé–‹å§‹');
    el.startScreen.style.display = 'none'; 
    el.cameraPrompt.style.display = 'flex';
});

el.restartButton.addEventListener('click', () => { 
    el.resultScreen.style.display = 'none'; 
    initGame(); 
});

el.confirmButton.addEventListener('click', () => { 
    if (gameState.isDetecting) confirmAnswer(); 
});

// è¨­å®š Marker ç›£è½
function setupMarkers() {
    const markers = document.querySelectorAll('a-marker');
    log('æ‰¾åˆ° ' + markers.length + ' å€‹ Marker');
    
    markers.forEach(marker => {
        marker.addEventListener('markerFound', e => { 
            log('Found: ' + e.target.id);
            startDetection(e.target.id); 
        });
        marker.addEventListener('markerLost', e => { 
            log('Lost: ' + e.target.id);
            if (gameState.scannedMarkerId === parseInt(e.target.id.split('-')[1])) {
                stopDetection();
            }
        });
    });
}

// åˆå§‹åŒ–
window.addEventListener('load', () => {
    log('é é¢è¼‰å…¥');
    
    // é è¼‰åœ–ç‰‡
    questionData.forEach(q => { const img = new Image(); img.src = q.image; });
    
    const scene = document.querySelector('a-scene');
    
    scene.addEventListener('loaded', () => {
        log('AR å ´æ™¯å°±ç·’');
        setupMarkers();
    });
    
    scene.addEventListener('arjs-video-loaded', () => {
        log('ç›¸æ©Ÿå·²å•Ÿå‹•');
    });
    
    // è¶…æ™‚ä¿è­·
    setTimeout(() => {
        if (!scene.hasLoaded) {
            log('å ´æ™¯è¼‰å…¥ä¸­...');
            setupMarkers();
        }
    }, 3000);
});

window.addEventListener('error', e => log('éŒ¯èª¤: ' + e.message));
</script>
</body>
</html>
