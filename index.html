<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…­å¤§é¡é£Ÿç‰©éŠæˆ²</title>
    
    <!-- ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„ç‰ˆæœ¬ -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
        }

        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(240, 240, 240, 0);
            z-index: 1;
            pointer-events: none;
        }

        #arjs-video {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            transform-origin: top left;
        }

        .a-canvas {
            z-index: 2 !important;
        }

        /* ===== é ‚éƒ¨ä»»å‹™æç¤ºå€ ===== */
        #mission-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 15px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 80%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        /* é¡Œè™Ÿèˆ‡é€²åº¦ */
        .question-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .question-number {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            width: 80px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* åˆ†æ•¸é¡¯ç¤º */
        .score-badge {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 3px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-badge .icon {
            font-size: 18px;
        }

        /* ===== ä»»å‹™å¡ç‰‡ - æ ¸å¿ƒæç¤º ===== */
        #mission-card {
            position: fixed;
            top: 70px;
            left: 15px;
            z-index: 99;
            background: white;
            border-radius: 16px;
            padding: 10px 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.5s ease;
            max-width: 200px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .mission-icon {
            width: 45px;
            height: 45px;
            min-width: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            animation: pulse 2s ease-in-out infinite;
        }

        .mission-text {
            display: flex;
            flex-direction: column;
        }

        .mission-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .mission-target {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        .mission-hint {
            display: none;
        }

        /* ===== æƒææˆåŠŸæç¤º ===== */
        #ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 98;
            text-align: center;
            background: white;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.25);
            display: none;
            animation: popUp 0.3s ease;
        }

        @keyframes popUp {
            from {
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }

        .scanned-food {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scanned-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .scanned-info {
            text-align: left;
        }

        #food-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #food-category {
            font-size: 12px;
            color: #666;
            margin-top: 1px;
        }

        #confirm-button {
            width: 100%;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
            transition: transform 0.2s;
        }

        #confirm-button:active {
            transform: scale(0.95);
        }

        /* ===== æƒææç¤ºå‹•ç•« ===== */
        #scan-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .scan-icon {
            animation: scanPulse 1.5s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== é€šçŸ¥è¨Šæ¯ ===== */
        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 25px 40px;
            border-radius: 20px;
            z-index: 200;
            font-size: 22px;
            font-weight: bold;
            display: none;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        /* ===== é–‹å§‹ç•«é¢ ===== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loading-text {
            color: white;
            font-size: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #start-screen h1 {
            color: white;
            font-size: 26px;
            margin-bottom: 15px;
            text-align: center;
        }

        #start-screen .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 25px;
        }

        #start-screen .instructions {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            color: white;
            max-width: 300px;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        #start-button {
            padding: 15px 50px;
            font-size: 20px;
            background: white;
            color: #764ba2;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        #marker-link {
            margin-top: 15px;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        /* ===== çµæœç•«é¢ ===== */
        #result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #result-screen h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
        }

        #result-screen .score-box {
            background: rgba(255,255,255,0.2);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        #result-screen .final-score {
            color: #FFD700;
            font-size: 60px;
            font-weight: bold;
        }

        #result-screen .score-label {
            color: white;
            font-size: 20px;
        }

        #restart-button {
            padding: 15px 40px;
            font-size: 18px;
            background: white;
            color: #11998e;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start-screen">
    <h1>ğŸ½ï¸ AR å…­å¤§é¡é£Ÿç‰©éŠæˆ²</h1>
    <p class="subtitle">å¤§ä»ç§‘æŠ€å¤§å­¸ ç¤¾æœƒå·¥ä½œç³»</p>
    <div class="instructions">
        <strong>ğŸ“‹ éŠæˆ²èªªæ˜</strong><br>
        1. ç•«é¢æœƒé¡¯ç¤ºç¼ºå°‘æŸé¡é£Ÿç‰©çš„é¤ç›¤<br>
        2. æ‰¾åˆ°å°æ‡‰çš„é£Ÿç‰©åœ–å¡ä¸¦æƒæ<br>
        3. é»æ“Šç¢ºèªæŒ‰éˆ•å¾—åˆ†<br>
        4. å…± 6 é¡Œï¼ŒæŒ‘æˆ°æ»¿åˆ†ï¼
    </div>
    <button id="start-button">ğŸ® é–‹å§‹éŠæˆ²</button>
    <a id="marker-link" href="marker-generator.html">ğŸ“„ æŸ¥çœ‹/åˆ—å°åœ–å¡</a>
</div>

<!-- è¼‰å…¥ç•«é¢ -->
<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div id="loading-text">æ¨¡å‹è¼‰å…¥ä¸­...</div>
</div>

<!-- çµæœç•«é¢ -->
<div id="result-screen">
    <h1>ğŸ‰ éŠæˆ²çµæŸï¼</h1>
    <div class="score-box">
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">åˆ†</div>
    </div>
    <button id="restart-button">ğŸ”„ å†ç©ä¸€æ¬¡</button>
</div>

<!-- éŠæˆ²ç•«é¢ -->
<div id="background"></div>

<!-- é ‚éƒ¨ä»»å‹™åˆ— -->
<div id="mission-bar">
    <div class="question-info">
        <div class="question-number" id="question-number">ç¬¬ 1 é¡Œ</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>
    <div class="score-badge">
        <span class="icon">â­</span>
        <span id="score-value">0</span> åˆ†
    </div>
</div>

<!-- ä»»å‹™å¡ç‰‡ - å‘Šè¨´ç©å®¶è¦æ‰¾ä»€éº¼ -->
<div id="mission-card">
    <div class="mission-icon" id="mission-icon">ğŸ¥¬</div>
    <div class="mission-text">
        <div class="mission-label">ğŸ” è«‹æ‰¾å‡ºç¼ºå°‘çš„é£Ÿç‰©</div>
        <div class="mission-target" id="mission-target">è”¬èœé¡</div>
        <div class="mission-hint">æƒæå°æ‡‰çš„åœ–å¡</div>
    </div>
</div>

<!-- æƒææç¤º -->
<div id="scan-hint">
    <span class="scan-icon">ğŸ“·</span>
    <span>å°æº–é£Ÿç‰©åœ–å¡æƒæ</span>
</div>

<!-- é€šçŸ¥ -->
<div id="notification">è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼</div>

<!-- AR å ´æ™¯ -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
    <a-assets>
        <a-asset-item id="food1-model" src="models/food_answer1.glb"></a-asset-item>
        <a-asset-item id="food2-model" src="models/food_answer2.glb"></a-asset-item>
        <a-asset-item id="food3-model" src="models/food_answer3.glb"></a-asset-item>
        <a-asset-item id="food4-model" src="models/food_answer4.glb"></a-asset-item>
        <a-asset-item id="food5-model" src="models/food_answer5.glb"></a-asset-item>
        <a-asset-item id="food6-model" src="models/food_answer6.glb"></a-asset-item>
    </a-assets>

    <a-marker id="marker1" type="pattern" url="markers/marker_food1.patt">
        <a-entity gltf-model="#food1-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker2" type="pattern" url="markers/marker_food2.patt">
        <a-entity gltf-model="#food2-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker3" type="pattern" url="markers/marker_food3.patt">
        <a-entity gltf-model="#food3-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker4" type="pattern" url="markers/marker_food4.patt">
        <a-entity gltf-model="#food4-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker5" type="pattern" url="markers/marker_food5.patt">
        <a-entity gltf-model="#food5-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker6" type="pattern" url="markers/marker_food6.patt">
        <a-entity gltf-model="#food6-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
</a-scene>

<!-- æƒææˆåŠŸ UI -->
<div id="ui-overlay">
    <div class="scanned-food">
        <div class="scanned-icon" id="scanned-icon">ğŸ¥¬</div>
        <div class="scanned-info">
            <div id="food-title">é«˜éº—èœ</div>
            <div id="food-category">è”¬èœé¡</div>
        </div>
    </div>
    <button id="confirm-button">âœ“ ç¢ºèªé¸æ“‡é€™å€‹é£Ÿç‰©</button>
</div>

<script>
// é¡Œç›®è³‡æ–™
const backgrounds = [
    {
        image: 'imgs/food_question1_0.png',
        marker: 'marker1',
        title: 'é«˜éº—èœ',
        category: 'è”¬èœé¡',
        emoji: 'ğŸ¥¬',
        color: '#4CAF50',
        bgColor: 'rgba(76, 175, 80, 0.15)'
    },
    {
        image: 'imgs/food_question2_0.png',
        marker: 'marker2',
        title: 'èŠ±ç”Ÿ',
        category: 'å …æœé¡',
        emoji: 'ğŸ¥œ',
        color: '#FDD835',
        bgColor: 'rgba(253, 216, 53, 0.15)'
    },
    {
        image: 'imgs/food_question3_0.png',
        marker: 'marker3',
        title: 'ç‰›æ’',
        category: 'è±†é­šè›‹è‚‰é¡',
        emoji: 'ğŸ¥©',
        color: '#FF6B6B',
        bgColor: 'rgba(255, 107, 107, 0.15)'
    },
    {
        image: 'imgs/food_question4_0.png',
        marker: 'marker4',
        title: 'æŸ³ä¸',
        category: 'æ°´æœé¡',
        emoji: 'ğŸŠ',
        color: '#E040FB',
        bgColor: 'rgba(224, 64, 251, 0.15)'
    },
    {
        image: 'imgs/food_question5_0.png',
        marker: 'marker5',
        title: 'ç™½é£¯',
        category: 'å…¨ç©€é›œç³§é¡',
        emoji: 'ğŸš',
        color: '#FFB74D',
        bgColor: 'rgba(255, 183, 77, 0.15)'
    },
    {
        image: 'imgs/food_question6_0.png',
        marker: 'marker6',
        title: 'ç‰›å¥¶',
        category: 'ä¹³å“é¡',
        emoji: 'ğŸ¥›',
        color: '#29B6F6',
        bgColor: 'rgba(41, 182, 246, 0.15)'
    }
];

// éŠæˆ²ç‹€æ…‹
let selectedBackgrounds = [];
let currentBackgroundIndex = 0;
let score = 0;
let questionsAnswered = 0;
let currentMarker = null;
let scannedMarker = null;
let loadedModels = 0;
const totalModels = 6;
const totalQuestions = 6;

// DOM å…ƒç´ 
const background = document.getElementById('background');
const uiOverlay = document.getElementById('ui-overlay');
const confirmButton = document.getElementById('confirm-button');
const notification = document.getElementById('notification');
const startScreen = document.getElementById('start-screen');
const startButton = document.getElementById('start-button');
const loadingOverlay = document.getElementById('loading-overlay');
const resultScreen = document.getElementById('result-screen');
const restartButton = document.getElementById('restart-button');
const scanHint = document.getElementById('scan-hint');

// æ—¥èªŒ
function log(msg) {
    console.log('[AR]', msg);
}

// æ´—ç‰Œ
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// é¸æ“‡é¡Œç›®
function selectRandomBackgrounds() {
    selectedBackgrounds = shuffleArray(backgrounds);
}

// æ›´æ–°ä»»å‹™å¡ç‰‡
function updateMissionCard() {
    const current = selectedBackgrounds[currentBackgroundIndex];
    
    // æ›´æ–°ä»»å‹™åœ–ç¤º
    const missionIcon = document.getElementById('mission-icon');
    missionIcon.textContent = current.emoji;
    missionIcon.style.background = current.bgColor;
    missionIcon.style.color = current.color;
    
    // æ›´æ–°ä»»å‹™ç›®æ¨™
    document.getElementById('mission-target').textContent = current.category;
    document.getElementById('mission-target').style.color = current.color;
    
    // æ›´æ–°é¡Œè™Ÿ
    document.getElementById('question-number').textContent = `ç¬¬ ${questionsAnswered + 1} é¡Œ`;
    
    // æ›´æ–°é€²åº¦æ¢
    const progress = (questionsAnswered / totalQuestions) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
}

// è¨­å®šèƒŒæ™¯
function setBackground() {
    const current = selectedBackgrounds[currentBackgroundIndex];
    background.style.backgroundImage = `url(${current.image})`;
    currentMarker = current.marker;
    updateMissionCard();
    log('é¡Œç›®: ' + current.category);
}

// æ›´æ–°åˆ†æ•¸
function updateScoreDisplay() {
    document.getElementById('score-value').textContent = score;
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(msg) {
    notification.textContent = msg || 'è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼';
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 1500);
}

// ä¸‹ä¸€é¡Œ
function nextQuestion() {
    questionsAnswered++;
    if (questionsAnswered < totalQuestions) {
        currentBackgroundIndex++;
        setBackground();
        uiOverlay.style.display = 'none';
        scanHint.style.display = 'flex';
        scannedMarker = null;
        showNotification('ä¸‹ä¸€é¡Œï¼');
    } else {
        endGame();
    }
}

// çµæŸéŠæˆ²
function endGame() {
    log('éŠæˆ²çµæŸ: ' + score + 'åˆ†');
    background.style.backgroundImage = 'none';
    uiOverlay.style.display = 'none';
    scanHint.style.display = 'none';
    document.getElementById('mission-bar').style.display = 'none';
    document.getElementById('mission-card').style.display = 'none';
    document.getElementById('final-score').textContent = score;
    resultScreen.style.display = 'flex';
}

// é–‹å§‹éŠæˆ²
function startGame() {
    log('éŠæˆ²é–‹å§‹');
    startScreen.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
        document.getElementById('mission-bar').style.display = 'flex';
        document.getElementById('mission-card').style.display = 'flex';
        scanHint.style.display = 'flex';
        selectRandomBackgrounds();
        currentBackgroundIndex = 0;
        score = 0;
        questionsAnswered = 0;
        scannedMarker = null;
        updateScoreDisplay();
        setBackground();
    }, 2000);
}

// é‡æ–°é–‹å§‹
function restartGame() {
    resultScreen.style.display = 'none';
    document.getElementById('mission-bar').style.display = 'flex';
    document.getElementById('mission-card').style.display = 'flex';
    scanHint.style.display = 'flex';
    selectRandomBackgrounds();
    currentBackgroundIndex = 0;
    score = 0;
    questionsAnswered = 0;
    scannedMarker = null;
    updateScoreDisplay();
    setBackground();
}

// ç¢ºèªæŒ‰éˆ•
confirmButton.addEventListener('click', () => {
    log('ç¢ºèª: ' + scannedMarker + ' vs ' + currentMarker);
    if (scannedMarker === currentMarker) {
        score++;
        updateScoreDisplay();
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'success',
            title: 'ç­”å°äº†ï¼+1 åˆ† ğŸ‰',
            showConfirmButton: false,
            timer: 1200,
            background: 'rgba(76,175,80,0.95)',
            color: 'white'
        });
    } else {
        const correct = selectedBackgrounds[currentBackgroundIndex];
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'error',
            title: `ç­”éŒ¯äº†ï¼æ­£ç¢ºæ˜¯ ${correct.category}`,
            showConfirmButton: false,
            timer: 1500,
            background: 'rgba(244,67,54,0.95)',
            color: 'white'
        });
    }
    setTimeout(nextQuestion, 1500);
});

startButton.addEventListener('click', startGame);
restartButton.addEventListener('click', restartGame);

// è§¸æ§æ§åˆ¶
const touchControls = {
    isMoving: false,
    isScaling: false,
    initialScale: {x: 0.1, y: 0.1, z: 0.1},
    initialRotation: {x: -90, y: 0, z: 0},
    lastPosition: {x: 0, y: 0},
    initialDistance: 0,
    currentModel: null,

    init() {
        document.querySelectorAll('a-marker').forEach(marker => {
            marker.addEventListener('markerFound', this.onMarkerFound.bind(this));
            marker.addEventListener('markerLost', this.onMarkerLost.bind(this));
        });

        document.addEventListener('touchstart', this.onTouchStart.bind(this));
        document.addEventListener('touchmove', this.onTouchMove.bind(this));
        document.addEventListener('touchend', this.onTouchEnd.bind(this));
        
        log('Marker ç›£è½å·²è¨­å®š');
    },

    onMarkerFound(event) {
        this.currentModel = event.target.querySelector('a-entity');
        if (this.currentModel) {
            this.initialScale = this.currentModel.getAttribute('scale');
            this.initialRotation = this.currentModel.getAttribute('rotation');

            scannedMarker = event.target.id;
            log('Found: ' + scannedMarker);
            
            const foodItem = backgrounds.find(bg => bg.marker === scannedMarker);
            if (foodItem) {
                // æ›´æ–°æƒæåˆ°çš„é£Ÿç‰©è³‡è¨Š
                document.getElementById('food-title').textContent = foodItem.title;
                document.getElementById('food-category').textContent = foodItem.category;
                document.getElementById('scanned-icon').textContent = foodItem.emoji;
                document.getElementById('scanned-icon').style.background = foodItem.bgColor;
                document.getElementById('scanned-icon').style.color = foodItem.color;
                
                uiOverlay.style.display = 'block';
                scanHint.style.display = 'none';
            }
        }
    },

    onMarkerLost(event) {
        log('Lost: ' + event.target.id);
        this.currentModel = null;
    },

    onTouchStart(event) {
        if (!this.currentModel) return;
        if (event.touches.length === 2) {
            this.isScaling = true;
            this.initialDistance = this.getDistance(event.touches[0], event.touches[1]);
        } else if (event.touches.length === 1) {
            this.isMoving = true;
            this.lastPosition = { x: event.touches[0].pageX, y: event.touches[0].pageY };
        }
    },

    onTouchMove(event) {
        if (!this.currentModel) return;
        if (this.isScaling && event.touches.length === 2) {
            const currentDistance = this.getDistance(event.touches[0], event.touches[1]);
            const scaleFactor = currentDistance / this.initialDistance;
            const minScale = 0.05, maxScale = 0.3;
            let newScale = {
                x: Math.min(Math.max(this.initialScale.x * scaleFactor, minScale), maxScale),
                y: Math.min(Math.max(this.initialScale.y * scaleFactor, minScale), maxScale),
                z: Math.min(Math.max(this.initialScale.z * scaleFactor, minScale), maxScale)
            };
            this.currentModel.setAttribute('scale', newScale);
        } else if (this.isMoving && event.touches.length === 1) {
            const deltaX = event.touches[0].pageX - this.lastPosition.x;
            const deltaY = event.touches[0].pageY - this.lastPosition.y;
            const currentPosition = this.currentModel.getAttribute('position');
            const sensitivity = 0.002;
            this.currentModel.setAttribute('position', {
                x: currentPosition.x + deltaX * sensitivity,
                y: currentPosition.y - deltaY * sensitivity,
                z: currentPosition.z
            });
            this.lastPosition = { x: event.touches[0].pageX, y: event.touches[0].pageY };
        }
    },

    onTouchEnd() {
        if (this.currentModel) {
            this.isMoving = false;
            this.isScaling = false;
            this.initialScale = this.currentModel.getAttribute('scale');
        }
    },

    getDistance(touch1, touch2) {
        const dx = touch1.pageX - touch2.pageX;
        const dy = touch1.pageY - touch2.pageY;
        return Math.sqrt(dx * dx + dy * dy);
    }
};

// æ¨¡å‹è¼‰å…¥
function checkAllModelsLoaded() {
    loadedModels++;
    document.getElementById('loading-text').textContent = `æ¨¡å‹è¼‰å…¥ä¸­... (${loadedModels}/${totalModels})`;
    if (loadedModels === totalModels) {
        log('æ‰€æœ‰æ¨¡å‹å·²è¼‰å…¥');
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    log('é é¢è¼‰å…¥å®Œæˆ');
    
    // éš±è—éŠæˆ² UI
    document.getElementById('mission-bar').style.display = 'none';
    document.getElementById('mission-card').style.display = 'none';
    scanHint.style.display = 'none';
    
    for (let i = 1; i <= totalModels; i++) {
        const model = document.querySelector(`#food${i}-model`);
        if (model) model.addEventListener('loaded', checkAllModelsLoaded);
    }
    
    const scene = document.querySelector('a-scene');
    if (scene.hasLoaded) {
        touchControls.init();
    } else {
        scene.addEventListener('loaded', () => {
            log('AR å ´æ™¯å°±ç·’');
            touchControls.init();
        });
    }
});
</script>
</body>
</html>
