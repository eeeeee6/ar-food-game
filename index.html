<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…­å¤§é¡é£Ÿç‰©éŠæˆ²</title>
    
    <!-- ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„ç‰ˆæœ¬ -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(240, 240, 240, 0);
            z-index: 1;
            pointer-events: none;
        }

        #arjs-video {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            transform-origin: top left;
        }

        .a-canvas {
            z-index: 2 !important;
        }

        #ui-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 15px;
            display: none;
        }

        #food-title {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #confirm-button {
            padding: 12px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 8px;
            font-weight: bold;
        }

        #score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #FFD700;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 4;
            font-size: 18px;
            font-weight: bold;
        }

        #question-title {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 4;
            font-size: 16px;
            font-weight: bold;
        }

        #question-title .target {
            display: none;
            margin-top: 5px;
            font-size: 14px;
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 5;
            font-size: 20px;
            display: none;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loading-text {
            color: white;
            font-size: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #start-screen h1 {
            color: white;
            font-size: 26px;
            margin-bottom: 15px;
            text-align: center;
        }

        #start-screen .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 25px;
        }

        #start-screen .instructions {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            color: white;
            max-width: 300px;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        #start-button {
            padding: 15px 50px;
            font-size: 20px;
            background: white;
            color: #764ba2;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        #marker-link {
            margin-top: 15px;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        #result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 25px;
        }

        #result-screen h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
        }

        #result-screen .score-box {
            background: rgba(255,255,255,0.2);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        #result-screen .final-score {
            color: #FFD700;
            font-size: 60px;
            font-weight: bold;
        }

        #result-screen .score-label {
            color: white;
            font-size: 20px;
        }

        #restart-button {
            padding: 15px 40px;
            font-size: 18px;
            background: white;
            color: #11998e;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }


    </style>
</head>
<body>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start-screen">
    <h1>ğŸ½ï¸ AR å…­å¤§é¡é£Ÿç‰©éŠæˆ²</h1>
    <p class="subtitle">å¤§ä»ç§‘æŠ€å¤§å­¸ ç¤¾æœƒå·¥ä½œç³»</p>
    <div class="instructions">
        <strong>ğŸ“‹ éŠæˆ²èªªæ˜</strong><br>
        1. ç•«é¢æœƒé¡¯ç¤ºç¼ºå°‘æŸé¡é£Ÿç‰©çš„é¤ç›¤<br>
        2. æ‰¾åˆ°å°æ‡‰çš„é£Ÿç‰©åœ–å¡ä¸¦æƒæ<br>
        3. é»æ“Šç¢ºèªæŒ‰éˆ•å¾—åˆ†<br>
        4. å…± 6 é¡Œï¼ŒæŒ‘æˆ°æ»¿åˆ†ï¼
    </div>
    <button id="start-button">ğŸ® é–‹å§‹éŠæˆ²</button>
    <a id="marker-link" href="marker-generator.html">ğŸ“„ æŸ¥çœ‹/åˆ—å°åœ–å¡</a>
</div>

<!-- è¼‰å…¥ç•«é¢ -->
<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div id="loading-text">æ¨¡å‹è¼‰å…¥ä¸­...</div>
</div>

<!-- çµæœç•«é¢ -->
<div id="result-screen">
    <h1>ğŸ‰ éŠæˆ²çµæŸï¼</h1>
    <div class="score-box">
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">åˆ†</div>
    </div>
    <button id="restart-button">ğŸ”„ å†ç©ä¸€æ¬¡</button>
</div>

<!-- éŠæˆ²ç•«é¢ -->
<div id="background"></div>
<div id="score-display">åˆ†æ•¸: 0</div>
<div id="question-title">ç¬¬1é¡Œ<span class="target"></span></div>
<div id="notification">è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼</div>


<!-- AR å ´æ™¯ - ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„è¨­å®š -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
        <a-asset-item id="food1-model" src="models/food_answer1.glb"></a-asset-item>
        <a-asset-item id="food2-model" src="models/food_answer2.glb"></a-asset-item>
        <a-asset-item id="food3-model" src="models/food_answer3.glb"></a-asset-item>
        <a-asset-item id="food4-model" src="models/food_answer4.glb"></a-asset-item>
        <a-asset-item id="food5-model" src="models/food_answer5.glb"></a-asset-item>
        <a-asset-item id="food6-model" src="models/food_answer6.glb"></a-asset-item>
    </a-assets>

    <!-- Marker è¨­å®š - èˆ‡åŸæœ¬ç›¸åŒ -->
    <a-marker id="marker1" type="pattern" url="markers/marker_food1.patt">
        <a-entity gltf-model="#food1-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker2" type="pattern" url="markers/marker_food2.patt">
        <a-entity gltf-model="#food2-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker3" type="pattern" url="markers/marker_food3.patt">
        <a-entity gltf-model="#food3-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker4" type="pattern" url="markers/marker_food4.patt">
        <a-entity gltf-model="#food4-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker5" type="pattern" url="markers/marker_food5.patt">
        <a-entity gltf-model="#food5-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-marker id="marker6" type="pattern" url="markers/marker_food6.patt">
        <a-entity gltf-model="#food6-model" scale="0.1 0.1 0.1" rotation="-90 0 0"></a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
</a-scene>

<!-- UI è¦†è“‹å±¤ -->
<div id="ui-overlay">
    <div id="food-title"></div>
    <button id="confirm-button">ç¢ºèªé¸æ“‡é€™å€‹é£Ÿç‰©</button>
</div>

<script>
// é¡Œç›®è³‡æ–™ - marker ç·¨è™Ÿèˆ‡ä½ åŸæœ¬ä¸€è‡´
const backgrounds = [
    {
        image: 'imgs/food_question1_0.png',
        marker: 'marker1',
        title: 'é«˜éº—èœ',
        category: 'è”¬èœé¡',
        color: '#4CAF50'
    },
    {
        image: 'imgs/food_question2_0.png',
        marker: 'marker2',
        title: 'èŠ±ç”Ÿ',
        category: 'å …æœé¡',
        color: '#FDD835'
    },
    {
        image: 'imgs/food_question3_0.png',
        marker: 'marker3',
        title: 'ç‰›æ’',
        category: 'è±†é­šè›‹è‚‰é¡',
        color: '#FF6B6B'
    },
    {
        image: 'imgs/food_question4_0.png',
        marker: 'marker4',
        title: 'æŸ³ä¸',
        category: 'æ°´æœé¡',
        color: '#E040FB'
    },
    {
        image: 'imgs/food_question5_0.png',
        marker: 'marker5',
        title: 'ç™½é£¯',
        category: 'å…¨ç©€é›œç³§é¡',
        color: '#FFB74D'
    },
    {
        image: 'imgs/food_question6_0.png',
        marker: 'marker6',
        title: 'ç‰›å¥¶',
        category: 'ä¹³å“é¡',
        color: '#29B6F6'
    }
];

// éŠæˆ²ç‹€æ…‹
let selectedBackgrounds = [];
let currentBackgroundIndex = 0;
let score = 0;
let questionsAnswered = 0;
let currentMarker = null;
let scannedMarker = null;
let loadedModels = 0;
const totalModels = 6;

// DOM å…ƒç´ 
const background = document.getElementById('background');
const uiOverlay = document.getElementById('ui-overlay');
const scoreDisplay = document.getElementById('score-display');
const confirmButton = document.getElementById('confirm-button');
const questionTitle = document.getElementById('question-title');
const notification = document.getElementById('notification');
const startScreen = document.getElementById('start-screen');
const startButton = document.getElementById('start-button');
const loadingOverlay = document.getElementById('loading-overlay');
const resultScreen = document.getElementById('result-screen');
const restartButton = document.getElementById('restart-button');

// æ—¥èªŒï¼ˆåªè¼¸å‡ºåˆ° consoleï¼‰
function log(msg) {
    console.log('[AR]', msg);
}

// æ´—ç‰Œå‡½æ•¸
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// é¸æ“‡éš¨æ©Ÿé¡Œç›®
function selectRandomBackgrounds() {
    selectedBackgrounds = shuffleArray(backgrounds);
}

// è¨­å®šèƒŒæ™¯
function setBackground() {
    const current = selectedBackgrounds[currentBackgroundIndex];
    background.style.backgroundImage = `url(${current.image})`;
    currentMarker = current.marker;
    log('é¡Œç›®: ' + current.category);
}

// æ›´æ–°åˆ†æ•¸é¡¯ç¤º
function updateScoreDisplay() {
    scoreDisplay.textContent = `åˆ†æ•¸: ${score}`;
}

// æ›´æ–°é¡Œç›®æ¨™é¡Œ
function updateQuestionTitle() {
    const current = selectedBackgrounds[currentBackgroundIndex];
    questionTitle.innerHTML = `ç¬¬${questionsAnswered + 1}é¡Œ<span class="target" style="color:${current.color}">æ‰¾ï¼š${current.category}</span>`;
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(msg) {
    notification.textContent = msg || 'è«‹æ‰¾ä¸‹ä¸€å€‹é£Ÿç‰©ï¼';
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 2000);
}

// ä¸‹ä¸€é¡Œ
function nextQuestion() {
    questionsAnswered++;
    if (questionsAnswered < 6) {
        currentBackgroundIndex++;
        setBackground();
        updateQuestionTitle();
        uiOverlay.style.display = 'none';
        scannedMarker = null;
        showNotification();
    } else {
        endGame();
    }
}

// çµæŸéŠæˆ²
function endGame() {
    log('éŠæˆ²çµæŸ: ' + score + 'åˆ†');
    background.style.backgroundImage = 'none';
    uiOverlay.style.display = 'none';
    document.getElementById('final-score').textContent = score;
    resultScreen.style.display = 'flex';
}

// é–‹å§‹éŠæˆ²
function startGame() {
    log('éŠæˆ²é–‹å§‹');
    startScreen.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    // ç­‰å¾…æ¨¡å‹è¼‰å…¥æˆ–è¶…æ™‚
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
        selectRandomBackgrounds();
        currentBackgroundIndex = 0;
        score = 0;
        questionsAnswered = 0;
        scannedMarker = null;
        updateScoreDisplay();
        setBackground();
        updateQuestionTitle();
    }, 2000);
}

// é‡æ–°é–‹å§‹
function restartGame() {
    resultScreen.style.display = 'none';
    selectRandomBackgrounds();
    currentBackgroundIndex = 0;
    score = 0;
    questionsAnswered = 0;
    scannedMarker = null;
    updateScoreDisplay();
    setBackground();
    updateQuestionTitle();
}

// ç¢ºèªæŒ‰éˆ•äº‹ä»¶
confirmButton.addEventListener('click', () => {
    log('ç¢ºèª: ' + scannedMarker + ' vs ' + currentMarker);
    if (scannedMarker === currentMarker) {
        score++;
        updateScoreDisplay();
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'success',
            title: 'ç­”å°äº†ï¼+1 åˆ† ğŸ‰',
            showConfirmButton: false,
            timer: 1200,
            background: 'rgba(76,175,80,0.95)',
            color: 'white'
        });
    } else {
        const correct = selectedBackgrounds[currentBackgroundIndex];
        Swal.fire({
            toast: true,
            position: 'center',
            icon: 'error',
            title: `ç­”éŒ¯äº†ï¼æ­£ç¢ºæ˜¯ ${correct.category}`,
            showConfirmButton: false,
            timer: 1500,
            background: 'rgba(244,67,54,0.95)',
            color: 'white'
        });
    }
    setTimeout(nextQuestion, 1500);
});

// é–‹å§‹æŒ‰éˆ•äº‹ä»¶
startButton.addEventListener('click', startGame);

// é‡æ–°é–‹å§‹æŒ‰éˆ•äº‹ä»¶
restartButton.addEventListener('click', restartGame);

// è§¸æ§æ§åˆ¶ç³»çµ±ï¼ˆä¾†è‡ªä½ çš„ ar-6-food-game.jsï¼‰
const touchControls = {
    isMoving: false,
    isScaling: false,
    initialScale: {x: 0.1, y: 0.1, z: 0.1},
    initialRotation: {x: -90, y: 0, z: 0},
    lastPosition: {x: 0, y: 0},
    initialDistance: 0,
    currentModel: null,

    init() {
        document.querySelectorAll('a-marker').forEach(marker => {
            marker.addEventListener('markerFound', this.onMarkerFound.bind(this));
            marker.addEventListener('markerLost', this.onMarkerLost.bind(this));
        });

        document.addEventListener('touchstart', this.onTouchStart.bind(this));
        document.addEventListener('touchmove', this.onTouchMove.bind(this));
        document.addEventListener('touchend', this.onTouchEnd.bind(this));
        
        log('Marker ç›£è½å·²è¨­å®š');
    },

    onMarkerFound(event) {
        this.currentModel = event.target.querySelector('a-entity');
        if (this.currentModel) {
            this.initialScale = this.currentModel.getAttribute('scale');
            this.initialRotation = this.currentModel.getAttribute('rotation');

            // è¨˜éŒ„æƒæåˆ°çš„ marker
            scannedMarker = event.target.id;
            log('Found: ' + scannedMarker);
            
            const foodItem = backgrounds.find(bg => bg.marker === scannedMarker);
            if (foodItem) {
                document.getElementById('food-title').textContent = foodItem.title;
                document.getElementById('food-title').style.color = foodItem.color;
                uiOverlay.style.display = 'block';
            }
        }
    },

    onMarkerLost(event) {
        log('Lost: ' + event.target.id);
        this.currentModel = null;
        // ä¸ç«‹å³éš±è— UIï¼Œè®“ç”¨æˆ¶å¯ä»¥é»æ“Šç¢ºèª
        // uiOverlay.style.display = 'none';
    },

    onTouchStart(event) {
        if (!this.currentModel) return;

        if (event.touches.length === 2) {
            this.isScaling = true;
            this.initialDistance = this.getDistance(event.touches[0], event.touches[1]);
        } else if (event.touches.length === 1) {
            this.isMoving = true;
            this.lastPosition = {
                x: event.touches[0].pageX,
                y: event.touches[0].pageY
            };
        }
    },

    onTouchMove(event) {
        if (!this.currentModel) return;

        if (this.isScaling && event.touches.length === 2) {
            const currentDistance = this.getDistance(event.touches[0], event.touches[1]);
            const scaleFactor = currentDistance / this.initialDistance;

            const minScale = 0.05;
            const maxScale = 0.3;
            let newScale = {
                x: Math.min(Math.max(this.initialScale.x * scaleFactor, minScale), maxScale),
                y: Math.min(Math.max(this.initialScale.y * scaleFactor, minScale), maxScale),
                z: Math.min(Math.max(this.initialScale.z * scaleFactor, minScale), maxScale)
            };

            this.currentModel.setAttribute('scale', newScale);

        } else if (this.isMoving && event.touches.length === 1) {
            const deltaX = event.touches[0].pageX - this.lastPosition.x;
            const deltaY = event.touches[0].pageY - this.lastPosition.y;

            const currentPosition = this.currentModel.getAttribute('position');
            const sensitivity = 0.002;

            this.currentModel.setAttribute('position', {
                x: currentPosition.x + deltaX * sensitivity,
                y: currentPosition.y - deltaY * sensitivity,
                z: currentPosition.z
            });

            this.lastPosition = {
                x: event.touches[0].pageX,
                y: event.touches[0].pageY
            };
        }
    },

    onTouchEnd() {
        if (this.currentModel) {
            this.isMoving = false;
            this.isScaling = false;
            this.initialScale = this.currentModel.getAttribute('scale');
        }
    },

    getDistance(touch1, touch2) {
        const dx = touch1.pageX - touch2.pageX;
        const dy = touch1.pageY - touch2.pageY;
        return Math.sqrt(dx * dx + dy * dy);
    }
};

// æ¨¡å‹è¼‰å…¥æª¢æŸ¥
function checkAllModelsLoaded() {
    loadedModels++;
    document.getElementById('loading-text').textContent = `æ¨¡å‹è¼‰å…¥ä¸­... (${loadedModels}/${totalModels})`;
    if (loadedModels === totalModels) {
        log('æ‰€æœ‰æ¨¡å‹å·²è¼‰å…¥');
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    log('é é¢è¼‰å…¥å®Œæˆ');
    
    // ç›£è½æ¨¡å‹è¼‰å…¥
    for (let i = 1; i <= totalModels; i++) {
        const model = document.querySelector(`#food${i}-model`);
        if (model) {
            model.addEventListener('loaded', checkAllModelsLoaded);
        }
    }
    
    // åˆå§‹åŒ–è§¸æ§æ§åˆ¶
    const scene = document.querySelector('a-scene');
    if (scene.hasLoaded) {
        touchControls.init();
    } else {
        scene.addEventListener('loaded', () => {
            log('AR å ´æ™¯å°±ç·’');
            touchControls.init();
        });
    }
});
</script>
</body>
</html>
